[{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing\"\u003eThe Approach: Metamorphic Testing\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance. \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e validates the system by checking relationships between different inputs or configurations.\u003c/p\u003e\n\u003cp\u003eI defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eHardware Offloading:\u003c/strong\u003e Running on a GPU should be faster than a CPU.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePolyhedral Optimization:\u003c/strong\u003e Code optimized with polyhedral techniques (tiling, fusion) should outperform the scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSemantic Equivalence:\u003c/strong\u003e Mathematically simplified code (e.g., applying the distributive property) should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using \u003cstrong\u003ePolygeist\u003c/strong\u003e to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nWe used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to rewrite expression trees (e.g., factoring out matrix multiplications). This also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing\"\u003eThe Approach: Metamorphic Testing\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance. \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e validates the system by checking relationships between different inputs or configurations.\u003c/p\u003e\n\u003cp\u003eI defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eHardware Offloading:\u003c/strong\u003e Running on a GPU should be faster than a CPU.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePolyhedral Optimization:\u003c/strong\u003e Code optimized with polyhedral techniques (tiling, fusion) should outperform the scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSemantic Equivalence:\u003c/strong\u003e Mathematically simplified code (e.g., applying the distributive property) should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using \u003cstrong\u003ePolygeist\u003c/strong\u003e to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nWe used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to rewrite expression trees (e.g., factoring out matrix multiplications). This also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing\"\u003eThe Approach: Metamorphic Testing\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance. \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e validates the system by checking relationships between different inputs or configurations.\u003c/p\u003e\n\u003cp\u003eI defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eHardware Offloading:\u003c/strong\u003e Running on a GPU should be faster than a CPU.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePolyhedral Optimization:\u003c/strong\u003e Code optimized with polyhedral techniques (tiling, fusion) should outperform the scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSemantic Equivalence:\u003c/strong\u003e Mathematically simplified code (e.g., applying the distributive property) should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using \u003cstrong\u003ePolygeist\u003c/strong\u003e to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nWe used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to rewrite expression trees (e.g., factoring out matrix multiplications). This also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"Tensorflow\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing\"\u003eThe Approach: Metamorphic Testing\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance. \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e validates the system by checking relationships between different inputs or configurations.\u003c/p\u003e\n\u003cp\u003eI defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eHardware Offloading:\u003c/strong\u003e Running on a GPU should be faster than a CPU.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePolyhedral Optimization:\u003c/strong\u003e Code optimized with polyhedral techniques (tiling, fusion) should outperform the scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSemantic Equivalence:\u003c/strong\u003e Mathematically simplified code (e.g., applying the distributive property) should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using \u003cstrong\u003ePolygeist\u003c/strong\u003e to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nWe used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to rewrite expression trees (e.g., factoring out matrix multiplications). This also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch1 id=\"automated-detection-of-performance-regressions-in-mlir\"\u003eAutomated Detection of Performance Regressions in MLIR\u003c/h1\u003e\n\u003cp\u003e\u003cstrong\u003eBy Poorna Gunathilaka\u003c/strong\u003e\u003c/p\u003e\n\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\n\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"XLA\"\u003e\n\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\n\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhe.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/diale.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e![]](/img/polyhedral.png)\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"[XLA]\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral \"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/mlir-wasm.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/mlir-cover.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale. You can find the source code and the paper of this project here\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/mlir-cover.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale. You can find the source code and the paper of this project [here]\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/mlir-cover.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale. You can find the source code and the paper of this project \u003ca href=\"\"\u003ehere\u003c/a\u003e\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/mlir-cover.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale. You can find the source code and the paper of this project \u003ca href=\"https://github.com/poorna2152/mmlir\"\u003ehere\u003c/a\u003e\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/mlir-cover.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale. You can find the source code and the paper of this project \u003ca href=\"https://github.com/poorna2152/mmlir\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/mlir-cover.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Mathematically simplified code should run at least as fast as the unsimplified version.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e I used \u003cstrong\u003eDialEgg\u003c/strong\u003e, an equality saturation tool, to generate semantically equivalent variants of input programs based on algebraic identities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e A compiler should never choose a mathematically more expensive path when a cheaper one exists. We specifically tested linear algebra identities that reduce operation counts, such as the distributive property:\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal Expression:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Approx. cost: $2N^3 + N^2$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten Expression:\u003c/em\u003e $D = A \\times (B + C)$ (Approx. cost: $N^3 + N^2$)\nThe rewritten form has significantly fewer floating-point operations and should always be faster.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale. You can find the source code and the paper of this project \u003ca href=\"https://github.com/poorna2152/mmlir\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/mlir-cover.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eDistributivity (Factorization):\u003c/strong\u003e Optimizes two matrix multiplications sharing a common operand.\n* \u003cem\u003eOriginal:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Cost: $\\approx 2N^3$)\n* \u003cem\u003eRewritten:\u003c/em\u003e $D = A \\times (B + C)$ (Cost: $\\approx 1N^3$)\n* \u003cem\u003eBenefit:\u003c/em\u003e Halves the dominant operation count.\n2.  \u003cstrong\u003eAssociativity Reordering:\u003c/strong\u003e Optimizes chain multiplication based on dimension sizes.\n* \u003cem\u003eOriginal:\u003c/em\u003e $D = (A \\times B) \\times C$\n* \u003cem\u003eRewritten:\u003c/em\u003e $D = A \\times (B \\times C)$\n* \u003cem\u003eBenefit:\u003c/em\u003e The compiler should choose the order that generates the smallest intermediate matrix, minimizing FLOPs.\n3.  \u003cstrong\u003eDiagonal Scaling:\u003c/strong\u003e Detects when a matrix multiplication is actually a scaling operation.\n* \u003cem\u003eOriginal:\u003c/em\u003e $D = A \\times \\text{diag}(v)$\n* \u003cem\u003eRewritten:\u003c/em\u003e $D_{ij} = A_{ij} \\times v_j$\n* \u003cem\u003eBenefit:\u003c/em\u003e Reduces complexity from cubic $O(N^3)$ to quadratic $O(N^2)$.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale. You can find the source code and the paper of this project \u003ca href=\"https://github.com/poorna2152/mmlir\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/mlir-cover.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eDistributivity (Factorization):\u003c/strong\u003e Optimizes two matrix multiplications sharing a common operand.\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Cost: $\\approx 2N^3$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten:\u003c/em\u003e $D = A \\times (B + C)$ (Cost: $\\approx 1N^3$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eBenefit:\u003c/em\u003e Halves the dominant operation count.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAssociativity Reordering:\u003c/strong\u003e Optimizes chain multiplication based on dimension sizes.\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal:\u003c/em\u003e $D = (A \\times B) \\times C$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten:\u003c/em\u003e $D = A \\times (B \\times C)$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eBenefit:\u003c/em\u003e The compiler should choose the order that generates the smallest intermediate matrix, minimizing FLOPs.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDiagonal Scaling:\u003c/strong\u003e Detects when a matrix multiplication is actually a scaling operation.\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal:\u003c/em\u003e $D = A \\times \\text{diag}(v)$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten:\u003c/em\u003e $D_{ij} = A_{ij} \\times v_j$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eBenefit:\u003c/em\u003e Reduces complexity from cubic $O(N^3)$ to quadratic $O(N^2)$.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale. You can find the source code and the paper of this project \u003ca href=\"https://github.com/poorna2152/mmlir\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/mlir-cover.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eDistributivity (Factorization):\u003c/strong\u003e Optimizes two matrix multiplications sharing a common operand.\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal:\u003c/em\u003e $D = (A \\times B) + (A \\times C)$ (Cost: $\\approx 2N^3$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten:\u003c/em\u003e $D = A \\times (B + C)$ (Cost: $\\approx 1N^3$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eBenefit:\u003c/em\u003e Halves the dominant operation count.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAssociativity Reordering:\u003c/strong\u003e Optimizes chain multiplication based on dimension sizes.\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal:\u003c/em\u003e $D = (A \\times B) \\times C$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten:\u003c/em\u003e $D = A \\times (B \\times C)$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eBenefit:\u003c/em\u003e The compiler should choose the order that generates the smallest intermediate matrix, minimizing FLOPs.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDiagonal Scaling:\u003c/strong\u003e Detects when a matrix multiplication is actually a scaling operation.\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal:\u003c/em\u003e $D = A \\times \\text{diag}(v)$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten:\u003c/em\u003e $D_{ij} = A_{ij} \\times v_j$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eBenefit:\u003c/em\u003e Reduces complexity from cubic $O(N^3)$ to quadratic $O(N^2)$.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale. You can find the source code and the paper of this project \u003ca href=\"https://github.com/poorna2152/mmlir\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/mlir-cover.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eDistributivity (Factorization):\u003c/strong\u003e Optimizes two matrix multiplications sharing a common operand.\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal:\u003c/em\u003e $D = (A \\cdot B) + (A \\cdot C)$ (Cost: $\\approx 2N^3$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten:\u003c/em\u003e $D = A \\cdot (B + C)$ (Cost: $\\approx N^3$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eBenefit:\u003c/em\u003e Halves the dominant operation count.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAssociativity Reordering:\u003c/strong\u003e Optimizes chain multiplication based on dimension sizes.\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal:\u003c/em\u003e $D = (A \\cdot B) \\cdot C$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten:\u003c/em\u003e $D = A \\cdot (B \\cdot C)$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eBenefit:\u003c/em\u003e The compiler should choose the order that generates the smallest intermediate matrix, minimizing FLOPs.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDiagonal Scaling:\u003c/strong\u003e Detects when a matrix multiplication is actually a scaling operation.\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal:\u003c/em\u003e $D = A \\cdot \\text{diag}(v)$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten:\u003c/em\u003e $D_{ij} = A_{ij} \\cdot v_j$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eBenefit:\u003c/em\u003e Reduces complexity from cubic $O(N^3)$ to quadratic $O(N^2)$.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale. You can find the source code and the paper of this project \u003ca href=\"https://github.com/poorna2152/mmlir\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/mlir-cover.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"},{"content":"\u003ch3 id=\"what-is-mlir-and-why-does-it-matter\"\u003eWhat is MLIR and Why Does It Matter?\u003c/h3\u003e\n\u003cp\u003eCompiler infrastructure has historically been fragmented. You had one representation for the high-level language (like the TensorFlow graph) and a completely different one for the low-level machine code (like LLVM IR). Moving between these levels often resulted in lost optimization opportunities.\u003c/p\u003e\n\u003cp\u003eMLIR (Multi-Level Intermediate Representation) solves this by providing a unified infrastructure. It allows compilers to define \u0026ldquo;dialects\u0026rdquo;—modular levels of abstraction that can mix and match. It serves as the backbone for modern machine learning compilers like XLA (used by TensorFlow, JAX, and PyTorch).\u003c/p\u003e\n\u003cp\u003eWhen you write code in JAX, it doesn\u0026rsquo;t go straight to machine code. It gets lowered into the \u003cstrong\u003eStableHLO\u003c/strong\u003e dialect, then usually to the \u003cstrong\u003eLinalg\u003c/strong\u003e or \u003cstrong\u003eAffine\u003c/strong\u003e dialects, and finally to LLVM IR or NVVM for hardware execution.\u003c/p\u003e\n\u003cp\u003eBecause MLIR sits right in the middle of this pipeline, it is the critical path for performance. If an MLIR pass handles a loop inefficiently, the final application runs slowly, regardless of how fast the hardware is.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/xla.png\" alt=\"XLA\"\u003e\u003c/p\u003e\n\u003ch3 id=\"the-problem-correctness-vs-performance\"\u003eThe Problem: Correctness vs. Performance\u003c/h3\u003e\n\u003cp\u003eMost compiler testing focuses on \u003cstrong\u003ecorrectness\u003c/strong\u003e. We run fuzzers to answer the question: \u003cem\u003e\u0026ldquo;Does the compiler crash, or does it produce the wrong number?\u0026rdquo;\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, in High-Performance Computing (HPC), a program that produces the right answer but takes 10x longer to run is effectively broken. These are \u003cstrong\u003eSilent Performance Regressions\u003c/strong\u003e. They are dangerous because they don\u0026rsquo;t throw errors; they just silently degrade the efficiency of the underlying hardware.\u003c/p\u003e\n\u003cp\u003eDetecting them is hard. To test correctness, you just need to check the output. To test performance, you typically need an \u0026ldquo;oracle\u0026rdquo;—you need to know exactly how fast the code \u003cem\u003eshould\u003c/em\u003e run. For random, generated test cases, calculating that theoretical speed is impossible.\u003c/p\u003e\n\u003cp\u003eI recently built a framework to automate performance testing for MLIR without needing a ground-truth oracle.\u003c/p\u003e\n\u003ch3 id=\"the-approach-metamorphic-testing-relations-and-tools\"\u003eThe Approach: Metamorphic Testing Relations and Tools\u003c/h3\u003e\n\u003cp\u003eSince we can\u0026rsquo;t predict absolute performance for random inputs, we look at relative performance using \u003cstrong\u003eMetamorphic Testing\u003c/strong\u003e. I defined three Metamorphic Relations (MRs) that a healthy MLIR compiler should satisfy, utilizing specific tools to define the expected performance behaviors.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow-mlir.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimization Relation (via Polygeist)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e Code optimized with polyhedral techniques should outperform a standard scalar CPU baseline.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eThe Tool:\u003c/strong\u003e To define the optimized baseline, I used \u003cstrong\u003ePolygeist\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWhy:\u003c/strong\u003e Standard compilers often struggle to automatically identify complex loop optimizations like tiling, parallelization, and fusion in scientific code. Polygeist uses the polyhedral model—a mathematical framework for analyzing loop nests—to automatically apply these advanced transformations. It lowers code to MLIR\u0026rsquo;s Affine dialect, representing a \u0026ldquo;best-case\u0026rdquo; scenario for CPU execution that the standard pipeline should aim to match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Equivalence Relation (via DialEgg)\u003c/strong\u003e\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eDistributivity (Factorization):\u003c/strong\u003e Optimizes two matrix multiplications sharing a common operand.\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal:\u003c/em\u003e $D = (A \\cdot B) + (A \\cdot C)$ (Cost: $\\approx 2N^3$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten:\u003c/em\u003e $D = A \\cdot (B + C)$ (Cost: $\\approx N^3$)\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eBenefit:\u003c/em\u003e Halves the dominant operation count.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAssociativity Reordering:\u003c/strong\u003e Optimizes chain multiplication based on dimension sizes.\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal:\u003c/em\u003e $D = (A \\cdot B) \\cdot C$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten:\u003c/em\u003e $D = A \\cdot (B \\cdot C)$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eBenefit:\u003c/em\u003e The compiler should choose the order that generates the smallest intermediate matrix, minimizing FLOPs.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDiagonal Scaling:\u003c/strong\u003e Detects when a matrix multiplication is actually a scaling operation.\n\u003cul\u003e\n\u003cli\u003e\u003cem\u003eOriginal:\u003c/em\u003e $D = A \\cdot \\text{diag}(v)$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eRewritten:\u003c/em\u003e $D_{ij} = A_{ij} \\cdot v_j$\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eBenefit:\u003c/em\u003e Reduces complexity from cubic $O(N^3)$ to quadratic $O(N^2)$.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003e3. Hardware Offloading Relation\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRelation:\u003c/strong\u003e For sufficient workloads, running on a GPU should be faster than a CPU. This tests the compiler\u0026rsquo;s ability to effectively lower StableHLO to NVVM (NVIDIA\u0026rsquo;s IR) versus LLVM CPU code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"input-generation-the-compute-bound-requirement\"\u003eInput Generation: The \u0026ldquo;Compute-Bound\u0026rdquo; Requirement\u003c/h3\u003e\n\u003cp\u003eGenerating valid inputs for performance testing is significantly harder than for crash testing.\u003c/p\u003e\n\u003cp\u003eFor the hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) to hold true, the input program must be \u003cstrong\u003ecomputationally heavy\u003c/strong\u003e. If a program is memory-bound (spending all its time moving data rather than calculating), the GPU\u0026rsquo;s massive parallelism provides no advantage, and the overhead of moving data across the PCIe bus actually makes the GPU slower.\u003c/p\u003e\n\u003cp\u003eThis requirement disqualified standard random code generators, which often produce \u0026ldquo;spaghetti code\u0026rdquo; with low arithmetic intensity.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy PolyBench?\u003c/strong\u003e\nI chose the \u003cstrong\u003ePolyBench\u003c/strong\u003e benchmark suite as the source of my inputs. PolyBench consists specifically of dense linear algebra kernels (like Matrix Multiplication and solvers) that have high arithmetic intensity. These are exactly the types of programs where a GPU \u003cem\u003eshould\u003c/em\u003e beat a CPU.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWhy TitanFuzz?\u003c/strong\u003e\nI extended \u003cstrong\u003eTitanFuzz\u003c/strong\u003e, an LLM-based fuzzer, because it supports \u003cstrong\u003eseed-based generation\u003c/strong\u003e. Unlike pure random generation, TitanFuzz allowed me to feed in the high-quality PolyBench kernels as seeds. The LLM could then mutate these seeds to create new test cases while preserving the underlying computationally heavy structure required for meaningful performance comparisons.\u003c/p\u003e\n\u003ch3 id=\"results-and-findings\"\u003eResults and Findings\u003c/h3\u003e\n\u003cp\u003eI evaluated the framework on 45 computational kernels. The data highlighted both successes and failures in the current MLIR ecosystem.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1. Polyhedral Optimizations are Consistent\u003c/strong\u003e\nThe relation \u003ccode\u003eTime(Polygeist) \u0026lt; Time(Baseline)\u003c/code\u003e held up well. Using Polygeist to raise code to the Affine dialect consistently improved performance.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e Speedups ranged from \u003cstrong\u003e1.50x\u003c/strong\u003e (for \u003ccode\u003eatax\u003c/code\u003e) to \u003cstrong\u003e8.45x\u003c/strong\u003e (for \u003ccode\u003e3mm\u003c/code\u003e), confirming that the polyhedral path is stable.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/polyhedral.png\" alt=\"Polyhedral results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2. Semantic Rewrites Work\u003c/strong\u003e\nThe relation based on DialEgg rewrites also passed consistently.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eResults:\u003c/strong\u003e The tool successfully optimized complex expressions, yielding speedups between \u003cstrong\u003e1.15x\u003c/strong\u003e and \u003cstrong\u003e2.48x\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/dialegg.png\" alt=\"Semantic Rewrite results\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3. The GPU \u0026ldquo;Crossover\u0026rdquo; Issue\u003c/strong\u003e\nThe hardware relation (\u003ccode\u003eTime(GPU) \u0026lt; Time(CPU)\u003c/code\u003e) revealed a significant limitation in simple performance testing.\u003c/p\u003e\n\u003cp\u003eWe found that we cannot simply assert that the GPU is faster. The relationship is strictly dependent on the \u003cstrong\u003eInput Size ($N$)\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=2048$ (Large):\u003c/strong\u003e The GPU path was massively faster. Compute-bound kernels like \u003ccode\u003ecomm\u003c/code\u003e saw speedups of \u003cstrong\u003e49.72x\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAt $N=512$ (Small):\u003c/strong\u003e The GPU path often failed. The \u003ccode\u003egesummv\u003c/code\u003e kernel ran at \u003cstrong\u003e0.67x\u003c/strong\u003e speed (a 33% slowdown) compared to the CPU.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/cpu-gpu.png\" alt=\"CPU vs GPU results\"\u003e\u003c/p\u003e\n\u003ch3 id=\"summary-and-future-work\"\u003eSummary and Future Work\u003c/h3\u003e\n\u003cp\u003eThis project demonstrates that we don\u0026rsquo;t need a theoretical oracle to find performance bugs. However, the results from the GPU experiments show that a simple \u0026ldquo;GPU \u0026gt; CPU\u0026rdquo; rule is insufficient.\u003c/p\u003e\n\u003cp\u003eTo make this test robust, we need to calculate the \u003cstrong\u003eCrossover Point\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eWe cannot blindly check if the GPU is faster. We need a mathematical equation—likely based on the kernel\u0026rsquo;s \u003cstrong\u003eArithmetic Intensity\u003c/strong\u003e (FLOPs per byte) and the hardware\u0026rsquo;s data transfer bandwidth—to predict the minimum input size $N$ required to hide the latency overhead.\u003c/p\u003e\n\u003cp\u003eImplementing this cost-model equation into the testing framework is the next step. It would allow the test to automatically skip the \u0026ldquo;GPU vs CPU\u0026rdquo; check for small inputs where the CPU is expected to win, preventing false positives and focusing the test on genuine regressions at scale. You can find the source code and the paper of this project \u003ca href=\"https://github.com/poorna2152/mmlir\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n","description":"Automated Detection of Performance Regressions in MLIR Optimizations via Metamorphic Testing","image":"/img/mlir-cover.png","permalink":"http://localhost:3000/blogs/tech/mlir-performance/","title":"Automated Detection of Performance Regressions in MLIR"},{"content":"\u003cp\u003eFinancial content coming soon! I\u0026rsquo;ll be sharing insights on:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePersonal finance strategies\u003c/li\u003e\n\u003cli\u003eInvestment approaches\u003c/li\u003e\n\u003cli\u003eFinancial independence journey\u003c/li\u003e\n\u003cli\u003eMoney management tips\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eStay tuned!\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/finance/coming-soon/","title":"Coming Soon: Financial Content"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I\u0026rsquo;ve mastered it. I\u0026rsquo;ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I\u0026rsquo;ve chased the dream of a visible six-pack. However, I\u0026rsquo;ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I\u0026rsquo;m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it\u0026rsquo;s not just about aesthetics anymore. It\u0026rsquo;s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn\u0026rsquo;t I think of this before? I\u0026rsquo;m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. It\u0026rsquo;s a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I\u0026rsquo;ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I\u0026rsquo;m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s time to stop going through the motions. I\u0026rsquo;ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":"My fitness journey from managing cholesterol to optimizing VO2 Max and setting new health goals","image":"/img/vo2.png","permalink":"http://localhost:3000/blogs/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eConsistency is often sold as the hardest part of fitness. For the last two years, I’ve mastered it. I’ve shown up to the gym more regularly than ever before in my life. But looking back, I realize that while my attendance was perfect, my effort was plateauing. I haven\u0026rsquo;t been pushing limits; I\u0026rsquo;ve been coasting in my comfort zone.\u003c/p\u003e\n\u003cp\u003eSo, let\u0026rsquo;s forget about the past. This post is about drawing a line in the sand and defining real targets.\u003c/p\u003e\n\u003ch2 id=\"the-last-layer-problem\"\u003eThe \u0026ldquo;Last Layer\u0026rdquo; Problem\u003c/h2\u003e\n\u003cp\u003eFor a long time, I’ve chased the dream of a visible six-pack. However, I’ve been stuck fighting that stubborn last layer of lower belly fat. We\u0026rsquo;ve all heard the sayings: \u003cem\u003e\u0026ldquo;You can\u0026rsquo;t spot reduce fat\u0026rdquo;\u003c/em\u003e and \u003cem\u003e\u0026ldquo;The last place you gain it is the last place you lose it.\u0026rdquo;\u003c/em\u003e I’m finding out the hard way that these are true. Sometimes I honestly wonder if there is a genetic component at play making it so difficult to lose that specific pocket of fat.\u003c/p\u003e\n\u003cp\u003eTo understand why this layer won\u0026rsquo;t budge, I have to look at my nutrition history. Before moving to the USA, I was working as a Software Engineer in Sri Lanka. I didn\u0026rsquo;t have total control over my meals, but I was strict about quantity. I cut out office snacks, mostly because a health check revealed a shock: my cholesterol was at \u003cstrong\u003e254\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThrough research, I learned that lifting weights alone wasn\u0026rsquo;t the magic bullet for cholesterol—I needed steady-state cardio. By incorporating incline walking and indoor cycling, I managed to pull my numbers down to \u003cstrong\u003e210\u003c/strong\u003e before leaving the country. I was disciplined then, avoiding chocolates and pastries.\u003c/p\u003e\n\u003ch2 id=\"the-american-diet-trap\"\u003eThe American Diet Trap\u003c/h2\u003e\n\u003cp\u003eThat discipline took a nosedive when I moved to the US. For whatever reason, I fell into the trap of ice cream, chocolates, and processed foods. That diet shift is exactly why that last layer of fat is still hanging around.\u003c/p\u003e\n\u003cp\u003eBut it’s not just about aesthetics anymore. It’s about longevity.\u003c/p\u003e\n\u003ch2 id=\"the-data-wake-up-call\"\u003eThe Data Wake-Up Call\u003c/h2\u003e\n\u003cp\u003eI recently read \u003cem\u003eOutlive\u003c/em\u003e by Peter Attia, which changed my perspective entirely. Attia places a massive emphasis on \u003cstrong\u003eVO2 Max\u003c/strong\u003e as a metric for longevity.\u003c/p\u003e\n\u003cp\u003eI bought an Oura Ring to track my health (though I sold it a month later—without a subscription, the data is useless). Before I sold it, I measured my VO2 Max. The result? \u003cstrong\u003e43\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eFor a 27-year-old, that is a shame. It shouldn\u0026rsquo;t be that low.\u003c/p\u003e\n\u003cp\u003eThe contrast became even sharper when I spoke to one of my advisors. He is nearly 60 years old but looks like he\u0026rsquo;s in his 40s. His secret? He runs and does interval training four times a week. His VO2 Max is \u003cstrong\u003e40\u003c/strong\u003e—almost the same as mine, despite a 30-year age gap.\u003c/p\u003e\n\u003cp\u003eMeanwhile, I was doing a \u0026ldquo;bro-split\u0026rdquo; (2 upper body days, 2 lower body days) and a lazy 30 minutes on the bike. I wasn\u0026rsquo;t even hitting 6,000 steps a day. I was lifting the same old weights, with no progressive overload and no real purpose.\u003c/p\u003e\n\u003ch2 id=\"the-realization-of-control\"\u003eThe Realization of Control\u003c/h2\u003e\n\u003cp\u003eI’m boiling this down to two main variables: nutrition and workout intensity. The plan seems simple: be strict with the diet and push much harder in the gym. It sounds like the perfect formula.\u003c/p\u003e\n\u003cp\u003eSo, why didn’t I think of this before? I’m pretty sure I \u003cem\u003edid\u003c/em\u003e think of it. I just failed to execute it.\u003c/p\u003e\n\u003cp\u003eWhat changed now? I realized that living independently means the end of the blame game. It took a while to settle down here in the US and identify how to control my environment, but finally I have some control. I am the only one who can fine-tune these parameters. Its a new year, and hopefully, I can tweak these parameters for the better.\u003c/p\u003e\n\u003ch2 id=\"the-2026-strategy\"\u003eThe 2026 Strategy\u003c/h2\u003e\n\u003cp\u003eThis year, the goal isn\u0026rsquo;t just to \u0026ldquo;go to the gym.\u0026rdquo; The goal is to prioritize my cardiac health and metabolism. Here is the plan:\u003c/p\u003e\n\u003ch3 id=\"1-nutrition-reset\"\u003e1. Nutrition Reset\u003c/h3\u003e\n\u003cp\u003eI am aggressively cutting down on processed foods and sugar, hopefully to zero. I’ve also started Intermittent Fasting (today is Day 1). I need to fix my metabolic baseline before I worry about anything else.\u003c/p\u003e\n\u003ch3 id=\"2-the-marathon-goal-delayed\"\u003e2. The Marathon Goal (Delayed)\u003c/h3\u003e\n\u003cp\u003eI would love to run a marathon this year. However, it is winter in Blacksburg, and buying the necessary cold-weather gear would cost me at least another $200. I’m going to be smart about this and wait until March to start formal marathon training.\u003c/p\u003e\n\u003ch3 id=\"3-the-winter-arc-routine\"\u003e3. The \u0026ldquo;Winter Arc\u0026rdquo; Routine\u003c/h3\u003e\n\u003cp\u003eUntil the weather warms up in March, I am switching my routine to a 6-day split focused on rebuilding my engine:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLegs:\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUpper Body:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eZone 2 Cardio (Bike):\u003c/strong\u003e 2 days\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eInterval Training:\u003c/strong\u003e 1 day\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis routine is designed to prep my body for the running volume coming in the spring.\u003c/p\u003e\n\u003cp\u003eIt’s time to stop going through the motions. I’ll keep updating this blog with my progress and new discoveries. There is a lot more to write about regarding nutrition specifics, sleep protocols, and flexibility work that I\u0026rsquo;ve discovered so far. I\u0026rsquo;ll keep adding to the story.\u003c/p\u003e\n\u003cp\u003eHere’s to finally losing that last layer. Happy New Year!\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003e(\u003cstrong\u003eMeta Note:\u003c/strong\u003e I used AI to refine the structure and flow of this article. Alas, what did you expect? I\u0026rsquo;m a Software Engineer.)\u003c/em\u003e\u003c/p\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/fitness/the-last-layer/","title":"The Last Layer: Rethinking My Fitness, From Cholesterol to VO2 Max"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netlify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch2 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend\u003c/h2\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\u003c/p\u003e\n\u003cp\u003enBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch2 id=\"implementation-of-subset01\"\u003eImplementation of subset01\u003c/h2\u003e\n\u003cp\u003eSubset01 of the language consist of:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-lisp\" data-lang=\"lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"implementation-of-subset02\"\u003eImplementation of subset02\u003c/h2\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\u003c/p\u003e\n\u003cp\u003eMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":"Developing a WebAssembly compiler backend for the Ballerina programming language","image":"/img/cover-wasm.png","permalink":"http://localhost:3000/blogs/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"\u003cp\u003eUp to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\u003c/p\u003e\n\u003cp\u003eMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\u003c/p\u003e\n\u003ch3 id=\"plan-for-wasm-backend\"\u003ePlan for WASM Backend.\u003c/h3\u003e\n\u003cp\u003eWebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.\nOur plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.\nSince nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.\nnBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm  backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/flow.png\" alt=\"Flow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\u003c/p\u003e\n\u003cp\u003eAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You\u0026rsquo;ll see why later in the article).\u003c/p\u003e\n\u003ch3 id=\"implementation-of-subset01\"\u003eImplementation of subset01.\u003c/h3\u003e\n\u003cp\u003eSubset01 of the language consist of,\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTypes: \u003ccode\u003eBoolean\u003c/code\u003e, \u003ccode\u003eIntegers\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConstructs: if-else and while, break, continue\u003c/li\u003e\n\u003cli\u003efunction println\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ewasm has integer types \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003ei64\u003c/code\u003e. Ballerina \u003ccode\u003ebooleans\u003c/code\u003e are mapped to an \u003ccode\u003ei32\u003c/code\u003e and \u003ccode\u003eintegers\u003c/code\u003e are mapped to \u003ccode\u003ei64s\u003c/code\u003e in the wasm.\nIn subset01 \u003ccode\u003eprintln\u003c/code\u003e function is called with an \u003ccode\u003ei64\u003c/code\u003e value. \u003ccode\u003ePrintln\u003c/code\u003e function was implemented using the \u003ccode\u003econsole.log\u003c/code\u003e function in Javascript.\u003c/p\u003e\n\u003cp\u003eLet\u0026rsquo;s consider the following simple program.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eballerina\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003epublic\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003ewhile\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a6e22e\"\u003eio\u003c/span\u003e:println(\u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/bir.png\" alt=\"BIR\"\u003e\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003e(%number)\u003c/code\u003e format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-Lisp\" data-lang=\"Lisp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e(module \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eimport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;console\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;log\u0026#34;\u003c/span\u003e (func $println (param i64)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (\u003cspan style=\"color:#a6e22e\"\u003eexport\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main\u0026#34;\u003c/span\u003e (func $main)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  (func $main \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $0 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local $1 i64) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $0 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (i64.const \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (loop $block$1$continue \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (i64.lt_s \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.get $0) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (i64.const \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        (\u003cspan style=\"color:#66d9ef\"\u003eblock\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $0\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (i64.const \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (local.set $1 \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            (i64.add \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $1) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              (local.get $0))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          (br $block$1$continue)))) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    (call $println\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      (local.get $1))))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"implementation-of-subset02\"\u003eImplementation of subset02.\u003c/h3\u003e\n\u003cp\u003eSubset02 of the language contains the type \u003ccode\u003eany\u003c/code\u003e. A \u003ccode\u003eboolean\u003c/code\u003e, \u003ccode\u003einteger\u003c/code\u003e or \u003ccode\u003enil\u003c/code\u003e value can be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e and a value assigned to an \u003ccode\u003eany\u003c/code\u003e can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent \u003ccode\u003eany\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e = \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eany\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ez\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u0026lt;\u003cspan style=\"color:#a6e22e\"\u003eboolean\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe variable \u003ccode\u003ey\u003c/code\u003e which is an \u003ccode\u003eany\u003c/code\u003e is casted to an \u003ccode\u003eint\u003c/code\u003e and assigned to variable \u003ccode\u003ez\u003c/code\u003e. Thus there should be a way to identify the runtime type of the value assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e, so we can ensure that the castings are valid.\nMy first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\u003c/p\u003e\n\u003cp\u003eIn nBallerina a variable of type \u003ccode\u003eany\u003c/code\u003e is represented with the LLVM type \u003ccode\u003ei64\u003c/code\u003e. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\u003c/p\u003e\n\u003cp\u003eSince \u003ccode\u003eintegers\u003c/code\u003e are also assigned to \u003ccode\u003eany\u003c/code\u003e, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type \u003ccode\u003eany\u003c/code\u003e. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tag.png\" alt=\"tagging\"\u003e\u003c/p\u003e\n\u003cp\u003eWasm has type \u003ccode\u003ei64\u003c/code\u003e and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\u003c/p\u003e\n\u003cp\u003eWhen we are storing values in memory we need to consider garbage collection. wasm doesn\u0026rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.\u003c/p\u003e\n\u003cp\u003eHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the \u003ccode\u003ei31ref\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e and \u003ccode\u003earray\u003c/code\u003e.\n\u003ccode\u003eStruct\u003c/code\u003e is a data type similar to a C struct where we can define a set of fields and their types.\u003c/p\u003e\n\u003cp\u003eNumerical values which can be represented using 31 bits can be stored in an \u003ccode\u003ei31\u003c/code\u003e. \u003ccode\u003ei31ref\u003c/code\u003e is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an \u003ccode\u003ei31ref\u003c/code\u003e, instead of wrapping in a \u003ccode\u003estruct\u003c/code\u003e, allows faster retrieval because it lives in the stack. So the plan was to use \u003ccode\u003ei31\u003c/code\u003e to store \u003ccode\u003ebooleans\u003c/code\u003e, \u003ccode\u003estruct\u003c/code\u003e to store \u003ccode\u003eints\u003c/code\u003e and \u003ccode\u003enull\u003c/code\u003e to store \u003ccode\u003enull\u003c/code\u003e. So the wasm type of a variable of type \u003ccode\u003eany\u003c/code\u003e would be a reference type (type \u003ccode\u003eeqref\u003c/code\u003e in wasm).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/tagint.png\" alt=\"tagging an int\"\u003e\u003c/p\u003e\n\u003cp\u003eWhen a variable is to be assigned to a variable of type \u003ccode\u003eany\u003c/code\u003e it is converted to the respective reference type. As per the above diagram  the \u003ccode\u003eint x\u003c/code\u003e is converted to a reference type \u003ccode\u003estruct\u003c/code\u003e using the \u003ccode\u003eint_to_tagged()\u003c/code\u003e function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type \u003ccode\u003e$BoxedInt\u003c/code\u003e with a field i64 to store the \u003ccode\u003eint\u003c/code\u003e value.\u003c/p\u003e\n\u003cp\u003eIn subset 02 \u003ccode\u003eprintln\u003c/code\u003e function  was called with a variable of type \u003ccode\u003eany\u003c/code\u003e. When \u003ccode\u003eprintln\u003c/code\u003e is called with a value of simple basic type it is first converted to \u003ccode\u003eany\u003c/code\u003e type. Then in Javascript side \u003ccode\u003econsole.log\u003c/code\u003e checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to \u003ccode\u003eany\u003c/code\u003e type, retrieving the original value back from \u003ccode\u003eany\u003c/code\u003e type and retrieving the runtime type of \u003ccode\u003eany\u003c/code\u003e variable are implemented in wasm and exported to Javascript so it can use them as necessary.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/println.png\" alt=\"println\"\u003e\u003c/p\u003e\n\u003cp\u003eThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.\nThe progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\u003c/p\u003e\n\u003ch3 id=\"references\"\u003eReferences\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eRepository: \u003ca href=\"https://github.com/poorna2152/nballerina\"\u003ehttps://github.com/poorna2152/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina repository: \u003ca href=\"https://github.com/ballerina-platform/nballerina\"\u003ehttps://github.com/ballerina-platform/nballerina\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina wasm branch: \u003ca href=\"https://github.com/ballerina-platform/nballerina/tree/wasm\"\u003ehttps://github.com/ballerina-platform/nballerina/tree/wasm\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003enBallerina runtime document: \u003ca href=\"https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\"\u003ehttps://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm use cases: \u003ca href=\"https://madewithwebassembly.com/\"\u003ehttps://madewithwebassembly.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eWasm compilers: \u003ca href=\"https://github.com/appcypher/awesome-wasm-langs\"\u003ehttps://github.com/appcypher/awesome-wasm-langs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://blog.container-solutions.com/webassembly-in-the-cloud\"\u003ehttps://blog.container-solutions.com/webassembly-in-the-cloud\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n","description":null,"image":null,"permalink":"http://localhost:3000/tech/wasm-backend/","title":"WebAssembly backend for Ballerina"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/posts/","title":"Posts"},{"content":"","description":null,"image":null,"permalink":"http://localhost:3000/search/","title":"Search"}]