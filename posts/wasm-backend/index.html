<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>WebAssembly backend for Ballerina | Poorna Gunathilaka</title>
<meta name=keywords content="wasm,ballerina"><meta name=description content="Up to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers."><meta name=author content="Me"><link rel=canonical href=https://poorna2152.github.io/posts/wasm-backend/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css integrity="sha256-7I2jZsovtkdTfMt6j2+ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as=style><link rel=icon href=https://img.icons8.com/external-flaticons-lineal-color-flat-icons/64/000000/external-programmer-mobile-app-development-flaticons-lineal-color-flat-icons.png><link rel=icon type=image/png sizes=16x16 href=https://img.icons8.com/external-flaticons-lineal-color-flat-icons/16/000000/external-programmer-mobile-app-development-flaticons-lineal-color-flat-icons.png><link rel=icon type=image/png sizes=32x32 href=https://img.icons8.com/external-flaticons-lineal-color-flat-icons/32/000000/external-programmer-mobile-app-development-flaticons-lineal-color-flat-icons.png><link rel=apple-touch-icon href=https://img.icons8.com/external-flaticons-lineal-color-flat-icons/64/000000/external-programmer-mobile-app-development-flaticons-lineal-color-flat-icons.png><link rel=mask-icon href=https://img.icons8.com/external-flaticons-lineal-color-flat-icons/64/000000/external-programmer-mobile-app-development-flaticons-lineal-color-flat-icons.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://poorna2152.github.io/posts/wasm-backend/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="WebAssembly backend for Ballerina"><meta property="og:description" content="Up to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers."><meta property="og:type" content="article"><meta property="og:url" content="https://poorna2152.github.io/posts/wasm-backend/"><meta property="og:image" content="https://poorna2152.github.io/img/cover-wasm.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-27T15:30:03+05:30"><meta property="article:modified_time" content="2022-06-27T15:30:03+05:30"><meta property="og:site_name" content="Poorna Gunathilaka"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://poorna2152.github.io/img/cover-wasm.png"><meta name=twitter:title content="WebAssembly backend for Ballerina"><meta name=twitter:description content="Up to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://poorna2152.github.io/posts/"},{"@type":"ListItem","position":2,"name":"WebAssembly backend for Ballerina","item":"https://poorna2152.github.io/posts/wasm-backend/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"WebAssembly backend for Ballerina","name":"WebAssembly backend for Ballerina","description":"Up to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers.","keywords":["wasm","ballerina"],"articleBody":"Up to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.\nMy internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.\nPlan for WASM Backend. WebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format. Our plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format. Since nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format. nBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.\nThe Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.\nAnother simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You’ll see why later in the article).\nImplementation of subset01. Subset01 of the language consist of,\nTypes: Boolean, Integers Constructs: if-else and while, break, continue function println wasm has integer types i32 and i64. Ballerina booleans are mapped to an i32 and integers are mapped to i64s in the wasm. In subset01 println function is called with an i64 value. Println function was implemented using the console.log function in Javascript.\nLet’s consider the following simple program.\nimport ballerina/io; public function main() { int i = 0; int sum = 0; while i \u003c 15 { i = i + 1; sum = sum + 1; } io:println(sum); } For this program the blocks in BIR representation and the corresponding WAT instructions are as follows.\nThe (%number) format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.\n(module (import \"console\" \"log\" (func $println (param i64))) (export \"main\" (func $main)) (func $main (local $0 i64) (local $1 i64) (local.set $0 (i64.const 0)) (local.set $1 (i64.const 0)) (loop $block$1$continue (if (i64.lt_s (local.get $0) (i64.const 15)) (block (local.set $0 (i64.add (local.get $0) (i64.const 1))) (local.set $1 (i64.add (local.get $1) (local.get $0))) (br $block$1$continue)))) (call $println (local.get $1)))) Implementation of subset02. Subset02 of the language contains the type any. A boolean, integer or nil value can be assigned to a variable of type any and a value assigned to an any can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent any.\nint x = 1; any y = x; int z = \u003cint\u003ey; boolean b = true; y = b; boolean c = \u003cboolean\u003ey; The variable y which is an any is casted to an int and assigned to variable z. Thus there should be a way to identify the runtime type of the value assigned to a variable of type any, so we can ensure that the castings are valid. My first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.\nIn nBallerina a variable of type any is represented with the LLVM type i64. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.\nSince integers are also assigned to any, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type any. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.\nWasm has type i64 and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.\nWhen we are storing values in memory we need to consider garbage collection. wasm doesn’t automatically garbage collect the values stored in memory. So this approach is not feasible.\nHowever wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the i31ref, struct and array. Struct is a data type similar to a C struct where we can define a set of fields and their types.\nNumerical values which can be represented using 31 bits can be stored in an i31. i31ref is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an i31ref, instead of wrapping in a struct, allows faster retrieval because it lives in the stack. So the plan was to use i31 to store booleans, struct to store ints and null to store null. So the wasm type of a variable of type any would be a reference type (type eqref in wasm).\nWhen a variable is to be assigned to a variable of type any it is converted to the respective reference type. As per the above diagram the int x is converted to a reference type struct using the int_to_tagged() function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type $BoxedInt with a field i64 to store the int value.\nIn subset 02 println function was called with a variable of type any. When println is called with a value of simple basic type it is first converted to any type. Then in Javascript side console.log checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to any type, retrieving the original value back from any type and retrieving the runtime type of any variable are implemented in wasm and exported to Javascript so it can use them as necessary.\nThis project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles. The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.\nReferences Repository: https://github.com/poorna2152/nballerina nBallerina repository: https://github.com/ballerina-platform/nballerina nBallerina wasm branch: https://github.com/ballerina-platform/nballerina/tree/wasm nBallerina runtime document: https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md Wasm use cases: https://madewithwebassembly.com/ Wasm compilers: https://github.com/appcypher/awesome-wasm-langs https://blog.container-solutions.com/webassembly-in-the-cloud ","wordCount":"1494","inLanguage":"en","image":"https://poorna2152.github.io/img/cover-wasm.png","datePublished":"2022-06-27T15:30:03+05:30","dateModified":"2022-06-27T15:30:03+05:30","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://poorna2152.github.io/posts/wasm-backend/"},"publisher":{"@type":"Organization","name":"Poorna Gunathilaka","logo":{"@type":"ImageObject","url":"https://img.icons8.com/external-flaticons-lineal-color-flat-icons/64/000000/external-programmer-mobile-app-development-flaticons-lineal-color-flat-icons.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://poorna2152.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></span></div><ul id=menu><li><a href=https://poorna2152.github.io/posts/ title=Posts><span>Posts</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://poorna2152.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://poorna2152.github.io/posts/>Posts</a></div><h1 class=post-title>WebAssembly backend for Ballerina</h1><div class=post-meta>&lt;span title='2022-06-27 15:30:03 +0530 +0530'>June 27, 2022&lt;/span>&amp;nbsp;·&amp;nbsp;8 min&amp;nbsp;·&amp;nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/poorna2152/tree/main/content/posts/wasm-backend.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://poorna2152.github.io/img/cover-wasm.png alt="Cover Photo"></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#plan-for-wasm-backend aria-label="Plan for WASM Backend.">Plan for WASM Backend.</a></li><li><a href=#implementation-of-subset01 aria-label="Implementation of subset01.">Implementation of subset01.</a></li><li><a href=#implementation-of-subset02 aria-label="Implementation of subset02.">Implementation of subset02.</a></li><li><a href=#references aria-label=References>References</a></li></ul></div></details></div><div class=post-content><p>Up to recently Javascript has been the only language which we can use to write programs for web browsers. Javascript is not suitable to run resource intensive applications such as AR-VR, video editing and 3D games. WebAssembly (wasm) was initially proposed as a compilation target for higher level languages which enabled them to run on web browsers with the additional performance gains for running computational intensive applications. Tensorflow, Unity, GoogleEarth and many more applications already use wasm to run on web browsers. With the invention of Web Assembly System Interface (WASI) the use cases of wasm have moved beyond the web browser. It is now fast becoming a language which is used for edge computing. Cloudflare workers, Netflify, Fastly provides options to deploy the code as wasm modules. Currently there are wasm compilers for 40+ languages such as C, C++, Java, Rust etc.</p><p>My internship project is to develop a backend for nBallerina compiler for generating wasm. Ballerina is an open source programming language designed specifically for writing distributed applications. nBallerina is the native compiler of the Ballerina language which is developed incrementally in subsets. Each subset adds a set of features to the language. Having a wasm backend for the Ballerina language provides the capability for it to run in a web browser and in standalone Javascript runtimes such as Node.</p><h3 id=plan-for-wasm-backend>Plan for WASM Backend.<a hidden class=anchor aria-hidden=true href=#plan-for-wasm-backend>#</a></h3><p>WebAssembly has two formats. The binary format and the text format. Text format (wat) is a human readable format.
Our plan is to emit the wasm text format and compile it to binary format using the Binaryen tool. Binaryen is a compiler and toolchain infrastructure library for WebAssembly which provides a C-API which can be used to generate wasm and it also provides tools which can be used to convert the wasm text format to binary format.
Since nBallerina compiler is yet to have a Foreign Function Interface we could not directly call the Binaryen C-API from the Ballerina code to produce wasm. Thus what we decided was to create a Ballerina module replicating the functionality of the Binaryen C-API. The functions in this module are then called to emit the wasm Text Format.
nBallerina compiler frontend emits the Ballerina Intermediate Representation(BIR) which is then consumed by the backend to generate LLVM. This BIR is also taken as the input for the new wasm backend. The generated wat file is converted to binary format using the Binaryen Optimizer tool which optimizes the code as well as outputs the binary format. Then the generated wasm file is run using a Javascript file.</p><p><img loading=lazy src=/img/flow.png alt=Flow></p><p>The Ballerina Intermediate representation is an unstructured control flow graph, but wasm is a structured control flow graph. Initially in the subset01 we were using the Relooper algorithm to convert the unstructured BIR to structured format. But later we added structured information to the BIR using a concept of Regions thus allowing us to remove the use of the Relooper algorithm.</p><p>Another simple approach to generate wasm would have been to use the LLVM emitted from the existing nBallerina backend and convert this to wasm. This is a straightforward conversion but we are not doing this because if we are to directly convert LLVM to wasm we might not be able to benefit from the higher level constructs that wasm provides for us such as Garbage collection (You&rsquo;ll see why later in the article).</p><h3 id=implementation-of-subset01>Implementation of subset01.<a hidden class=anchor aria-hidden=true href=#implementation-of-subset01>#</a></h3><p>Subset01 of the language consist of,</p><ul><li>Types: <code>Boolean</code>, <code>Integers</code></li><li>Constructs: if-else and while, break, continue</li><li>function println</li></ul><p>wasm has integer types <code>i32</code> and <code>i64</code>. Ballerina <code>booleans</code> are mapped to an <code>i32</code> and <code>integers</code> are mapped to <code>i64s</code> in the wasm.
In subset01 <code>println</code> function is called with an <code>i64</code> value. <code>Println</code> function was implemented using the <code>console.log</code> function in Javascript.</p><p>Let&rsquo;s consider the following simple program.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>    <span class=kn>import</span> <span class=nx>ballerina</span><span class=o>/</span><span class=nx>io</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>public</span> <span class=nx>function</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=nx>i</span> <span class=p>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=nx>sum</span> <span class=p>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>while</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=mi>15</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>i</span> <span class=p>=</span> <span class=nx>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nx>sum</span> <span class=p>=</span> <span class=nx>sum</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>io</span><span class=p>:</span><span class=nb>println</span><span class=p>(</span><span class=nx>sum</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>For this program the blocks in BIR representation and the corresponding WAT instructions are as follows.</p><p><img loading=lazy src=/img/bir.png alt=BIR></p><p>The <code>(%number)</code> format in the above represents a register number in the ballerina. The registers are mapped to local variables in wasm function. The complete code looks like this.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Lisp data-lang=Lisp><span class=line><span class=cl><span class=p>(</span><span class=nv>module</span> 
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nf>import</span> <span class=s>&#34;console&#34;</span> <span class=s>&#34;log&#34;</span> <span class=p>(</span><span class=nv>func</span> <span class=nv>$println</span> <span class=p>(</span><span class=nv>param</span> <span class=nv>i64</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nf>export</span> <span class=s>&#34;main&#34;</span> <span class=p>(</span><span class=nv>func</span> <span class=nv>$main</span><span class=p>))</span> 
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nv>func</span> <span class=nv>$main</span> 
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nv>local</span> <span class=nv>$0</span> <span class=nv>i64</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nv>local</span> <span class=nv>$1</span> <span class=nv>i64</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nv>local.set</span> <span class=nv>$0</span> 
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nv>i64.const</span> <span class=mi>0</span><span class=p>))</span> 
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nv>local.set</span> <span class=nv>$1</span> 
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nv>i64.const</span> <span class=mi>0</span><span class=p>))</span> 
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nb>loop</span> <span class=nv>$block$1$continue</span> 
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=k>if</span> 
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nv>i64.lt_s</span> 
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=nv>local.get</span> <span class=nv>$0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=nv>i64.const</span> <span class=mi>15</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=k>block</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=nv>local.set</span> <span class=nv>$0</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=nv>i64.add</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nv>local.get</span> <span class=nv>$0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nv>i64.const</span> <span class=mi>1</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=nv>local.set</span> <span class=nv>$1</span> 
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=nv>i64.add</span> 
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nv>local.get</span> <span class=nv>$1</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nv>local.get</span> <span class=nv>$0</span><span class=p>)))</span> 
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=nv>br</span> <span class=nv>$block$1$continue</span><span class=p>))))</span> 
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nv>call</span> <span class=nv>$println</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nv>local.get</span> <span class=nv>$1</span><span class=p>))))</span>
</span></span></code></pre></div><h3 id=implementation-of-subset02>Implementation of subset02.<a hidden class=anchor aria-hidden=true href=#implementation-of-subset02>#</a></h3><p>Subset02 of the language contains the type <code>any</code>. A <code>boolean</code>, <code>integer</code> or <code>nil</code> value can be assigned to a variable of type <code>any</code> and a value assigned to an <code>any</code> can be casted back to its original type. The next step in implementation was to figure out the wasm type that we can use to represent <code>any</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>    <span class=kt>int</span> <span class=nx>x</span> <span class=p>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>any</span> <span class=nx>y</span> <span class=p>=</span> <span class=nx>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=nx>z</span> <span class=p>=</span> <span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;</span><span class=nx>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>boolean</span> <span class=nx>b</span> <span class=p>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>y</span> <span class=p>=</span> <span class=nx>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>boolean</span> <span class=nx>c</span> <span class=p>=</span> <span class=p>&lt;</span><span class=nx>boolean</span><span class=p>&gt;</span><span class=nx>y</span><span class=p>;</span>
</span></span></code></pre></div><p>The variable <code>y</code> which is an <code>any</code> is casted to an <code>int</code> and assigned to variable <code>z</code>. Thus there should be a way to identify the runtime type of the value assigned to a variable of type <code>any</code>, so we can ensure that the castings are valid.
My first attempt in approaching this problem was to look at what nBallerina already does and replicate its behavior in the wasm side.</p><p>In nBallerina a variable of type <code>any</code> is represented with the LLVM type <code>i64</code>. The first 56 bits out of 64 were used to represent the actual value; the remaining 8 bits were used as a tag. This tag contains information about the runtime type of the variable stored.</p><p>Since <code>integers</code> are also assigned to <code>any</code>, what if we want to assign an integer whose binary representation uses more than 56 bits to a variable of type <code>any</code>. In this case nBallerina stores the actual value in the memory and then gets the memory address and stores this memory address in the first 56 bits. There is also a bit in the tag to represent whether the value is an immediate or a memory stored one.</p><p><img loading=lazy src=/img/tag.png alt=tagging></p><p>Wasm has type <code>i64</code> and it also has a memory to which we can store and retrieve values. So we should be able to replicate this in the wasm side right? Unfortunately no.</p><p>When we are storing values in memory we need to consider garbage collection. wasm doesn&rsquo;t automatically garbage collect the values stored in memory. So this approach is not feasible.</p><p>However wasm already has a Garbage Collection(GC) proposal. Even though this is a proposal there is an implemented MVP. This proposal introduces a set of reference types which are garbage collected. Namely the <code>i31ref</code>, <code>struct</code> and <code>array</code>.
<code>Struct</code> is a data type similar to a C struct where we can define a set of fields and their types.</p><p>Numerical values which can be represented using 31 bits can be stored in an <code>i31</code>. <code>i31ref</code> is capable of storing references in the form of offsets in wasm linear memory, as well as numbers. Storing numbers in an <code>i31ref</code>, instead of wrapping in a <code>struct</code>, allows faster retrieval because it lives in the stack. So the plan was to use <code>i31</code> to store <code>booleans</code>, <code>struct</code> to store <code>ints</code> and <code>null</code> to store <code>null</code>. So the wasm type of a variable of type <code>any</code> would be a reference type (type <code>eqref</code> in wasm).</p><p><img loading=lazy src=/img/tagint.png alt="tagging an int"></p><p>When a variable is to be assigned to a variable of type <code>any</code> it is converted to the respective reference type. As per the above diagram the <code>int x</code> is converted to a reference type <code>struct</code> using the <code>int_to_tagged()</code> function. We can give a type name, field type and field names when defining a struct. In this case it is a struct of type <code>$BoxedInt</code> with a field i64 to store the <code>int</code> value.</p><p>In subset 02 <code>println</code> function was called with a variable of type <code>any</code>. When <code>println</code> is called with a value of simple basic type it is first converted to <code>any</code> type. Then in Javascript side <code>console.log</code> checks for the type of the reference it got and retrieves the value accordingly. The functions for converting to <code>any</code> type, retrieving the original value back from <code>any</code> type and retrieving the runtime type of <code>any</code> variable are implemented in wasm and exported to Javascript so it can use them as necessary.</p><p><img loading=lazy src=/img/println.png alt=println></p><p>This project is still going and currently I have finished subset09 of the language. I will cover more about my implementation of lists, maps and records in future articles.
The progress I have made so far has been with the help of my mentor Manuranga Perera, nBallerina team lead James Clark and the nBallerina team.</p><h3 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h3><ol><li>Repository: <a href=https://github.com/poorna2152/nballerina>https://github.com/poorna2152/nballerina</a></li><li>nBallerina repository: <a href=https://github.com/ballerina-platform/nballerina>https://github.com/ballerina-platform/nballerina</a></li><li>nBallerina wasm branch: <a href=https://github.com/ballerina-platform/nballerina/tree/wasm>https://github.com/ballerina-platform/nballerina/tree/wasm</a></li><li>nBallerina runtime document: <a href=https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md>https://github.com/poorna2152/nballerina/blob/main/docs/rtvalue.md</a></li><li>Wasm use cases: <a href=https://madewithwebassembly.com/>https://madewithwebassembly.com/</a></li><li>Wasm compilers: <a href=https://github.com/appcypher/awesome-wasm-langs>https://github.com/appcypher/awesome-wasm-langs</a></li><li><a href=https://blog.container-solutions.com/webassembly-in-the-cloud>https://blog.container-solutions.com/webassembly-in-the-cloud</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://poorna2152.github.io/tags/wasm/>Wasm</a></li><li><a href=https://poorna2152.github.io/tags/ballerina/>Ballerina</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share WebAssembly backend for Ballerina on twitter" href="https://twitter.com/intent/tweet/?text=WebAssembly%20backend%20for%20Ballerina&amp;url=https%3a%2f%2fpoorna2152.github.io%2fposts%2fwasm-backend%2f&amp;hashtags=wasm%2cballerina"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share WebAssembly backend for Ballerina on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fpoorna2152.github.io%2fposts%2fwasm-backend%2f&amp;title=WebAssembly%20backend%20for%20Ballerina&amp;summary=WebAssembly%20backend%20for%20Ballerina&amp;source=https%3a%2f%2fpoorna2152.github.io%2fposts%2fwasm-backend%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share WebAssembly backend for Ballerina on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fpoorna2152.github.io%2fposts%2fwasm-backend%2f&title=WebAssembly%20backend%20for%20Ballerina"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share WebAssembly backend for Ballerina on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fpoorna2152.github.io%2fposts%2fwasm-backend%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share WebAssembly backend for Ballerina on whatsapp" href="https://api.whatsapp.com/send?text=WebAssembly%20backend%20for%20Ballerina%20-%20https%3a%2f%2fpoorna2152.github.io%2fposts%2fwasm-backend%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share WebAssembly backend for Ballerina on telegram" href="https://telegram.me/share/url?text=WebAssembly%20backend%20for%20Ballerina&amp;url=https%3a%2f%2fpoorna2152.github.io%2fposts%2fwasm-backend%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://poorna2152.github.io/>Poorna Gunathilaka</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>